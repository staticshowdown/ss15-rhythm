<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">


<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">


<link rel="import" href="../../elements/hack-header/hack-header.html">
<link rel="import" href="../../elements/hack-table/hack-table.html">

<polymer-element name="hack-app" attributes="game_id">
  <template>
    <link rel="stylesheet" href="hack-app.css">

    <firebase-element id="base"
      location="{{globals.firebase}}"
      data="{{data}}"
      keys="{{keys}}"
      ref="{{fbRef}}"
      childEvents
      on-child-changed={{childUpdated}}
      >
    </firebase-element>
    <pvc-globals values="{{globals}}"></pvc-globals>

    <div>
      <hack-header game_id="{{game_id}}" player_id="{{player_id}}" game={{game}}></hack-header>
      <hack-table game_id="{{game_id}}" player_id="{{player_id}}"></hack-table>
    </div>

    <!-- TEMPORARY FOR TESTING -->
    <div style="position: absolute; bottom: 0; background : #fff; left:0; right: 0;">
     <div horizontal layout>
      <paper-button raised flex
        hidden?="{{!started}}"
        on-tap="{{nextStage}}">
        <core-icon icon="arrow-forward"></core-icon>
        Next Step
      </paper-button>
      <paper-button raised flex
        hidden?="{{started}}"
        on-tap="{{startGame}}">
        Start Game
      </paper-button>
      <paper-button raised flex
        hidden?="{{started}}"
        on-tap="{{joinGame}}">
        Join Game
      </paper-button>
     </div>
    </div>

  </template>
  <script>
    (function (app, RSVP) {
      Polymer({
        url : "https://ss15-rhythm.firebaseio.com/",
        game_id : "defaultGame",
        player_id: "",
        userAuth: null,
        started: false,
        game: {},
        turns: {},
        turn: {},
        stage: {},
        currentPlayer: {},
        turnIndex : 0,
        stageIndex: 0,
        message: '',

        ready : function () {
          this.globals.firebase = this.url + this.game_id;
          console.log(this.globals.firebase);
        },

        startGame: function() {
          app.game.start();
          this.started = true;
          this.game = app.game;
          this.turns = this.game.turns;
          this.update();
        },

        joinGame: function () {
          this.getUserId().then(function(uid) {
            app.game.addPlayer(new app.Player(uid));
            this.setPlayers(app.game.players);
          });
        },

        update: function () {
          this.turn = this.turns.getCurrent();
          this.stage = this.turn.getCurrentStage();
          this.currentPlayer = this.turn.player;
          this.turnIndex = this.turns.index;
          this.stageIndex = this.turn.index;
          this.message = this.stage.description;
        },

        nextTurn: function () {
          this.turns.nextTurn();
          this.update();
        },

        nextStage: function () {
          this.turn.nextStage();
          if (this.stage) {
            this.update();
          } else {
            this.nextTurn();
          }
        },

        doStageAction: function () {
          this.stage.action();
        },

        getUserId: function () {
          var that = this;
          return new RSVP.Promise(function(resolve, reject) {
            if (!that.userAuth) {
              that.updateUserAuth.then(function(userAuth){
                resolve(userAuth.uid);
              }, function(error) {
                reject(error);
                console.log(error);
              });
            } else {
              that.resolve(that.userAuth.uid);
            }
          });
        },

        updateUserAuth: function (callback) {
          var that = this;
          return new RSVP.Promise(function(resolve, reject) {
            that.fbRef.authAnonymously(function(error, authData) {
              if (error) {
                reject(error);
                console.log("Login Failed!", error);
              } else {
                that.userAuth = authData;
                resolve(authData);
                console.log("Authenticated successfully with payload:", authData);
              }
            });
          });
        },

        // Methods
        resetGame : function () {
          this.data = {
            turn : 0,
            stage : 0,
            players : []
          }
        },

        setTurn: function (turn) {
          if (!this.data) this.resetGame();
          this.data.turn = turn || 0;
        },

        setPlayers: function (players) {
          if (!this.data) this.resetGame();
          this.data.players = players || [];
        },

        setStage: function (stage) {
          if (!this.data) this.resetGame();
          this.data.stage = stage || 0;
        },

      });
    })(app, RSVP);
  </script>
</polymer-element>
