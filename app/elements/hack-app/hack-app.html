<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">

<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../elements/hack-header/hack-header.html">
<link rel="import" href="../../elements/hack-table/hack-table.html">

<polymer-element name="hack-app" attributes="gameId">
  <template>
    <link rel="stylesheet" href="hack-app.css">

    <firebase-element id="base"
      location="{{globals.firebase}}"
      data="{{data}}"
      keys="{{keys}}"
      ref="{{fbRef}}"
      childEvents
      on-child-changed={{childUpdated}}>
    </firebase-element>

    <firebase-element id="root"
      location="{{url}}"
      data="{{rootData}}"
      keys="{{rootKeys}}"
      ref="{{rootRef}}">
    </firebase-element>

    <pvc-globals values="{{globals}}"></pvc-globals>

    <div>
      <hack-header
        started="{{data.started}}"
        turnIndex="{{data.turnIndex}}"
        message="{{data.message}}"
        players="{{data.players}}"
        gameId="{{gameId}}">
      </hack-header>
      <hack-table gameId="{{gameId}}" deck="{{deck}}"></hack-table>
    </div>

    <div style="position: absolute; bottom: 0; background : #fff; left:0; right: 0;">
     <div horizontal layout>
      <paper-button raised flex
        hidden?="{{!data.started || !myTurn}}"
        on-tap="{{nextStage}}">
        <core-icon icon="arrow-forward"></core-icon>
        Next
      </paper-button>
      <paper-button raised flex
        hidden?="{{data.started || !joined}}"
        on-tap="{{startGame}}">
        Start Game
      </paper-button>
      <paper-button raised flex
        hidden?="{{joined}}"
        on-tap="{{joinGame}}">
        Join Game
      </paper-button>
     </div>
    </div>

  </template>
  <script>
    (function (app, R, RSVP) {
      'use strict';

      var game, Player;

      Polymer({

        url : 'https://ss15-rhythm.firebaseio.com/',
        gameId : 'defaultGame',
        joined: false,
        myTurn: false,
        userAuth: { uid: null },
        observe: {
          'data.started': 'initGame',
          'data.deck': 'updateDeck',
          'data.turnIndex': 'updateMyTurn'
          },

        ready: function () {
          this.globals.firebase = this.url + this.gameId;
          game = this.game = app.game;
          Player = app.Player;
        },

        rootDataChanged: function () {
          this.newGameId(this.gameId);
        },

        newGameId: function (id) {
          var validId = (this.rootKeys.indexOf(id.toString()) !== -1 && id !== '');
          if (!validId) {
            var newId = this.rootRef.push({'bogus':'data'}).key();
            this.gameId = newId;
            window.location.hash = '#/' + newId;
          }
        },

        startGame: function() {
          var that = this;
          this.data.started = true;
          game.started.then(function (game) {
            that.data.deck = R.flatten(R.zipWith(R.repeat, [0, 1, 2, 3], [5, 5, 5, 5] ));
            game.adminDeck.shuffle();
          });
        },

        initGame: function () {
          game.setModel(this.data);
          game.start();
          this.updateMessage();
        },

        joinGame: function () {
          var that = this;
          if (!that.data) { that.initData(); }

          // get current user
          this.authenticate().then(function(userAuth) {

            // add me
            var me = new Player({uid: userAuth.uid});
            that.data.players = R.concat(that.data.players || [], [me]);
            that.joined = true;
          });
        },

        authenticate: function () {
          var that = this;
          return new RSVP.Promise(function(resolve, reject) {
            that.fbRef.authAnonymously(function(error, userAuth) {
              if (error) {
                reject(error);
                console.log('Login Failed!', error);
              } else {
                that.userAuth = userAuth;
                resolve(userAuth);
                console.log('Authenticated successfully with payload:', userAuth);
              }
            });
          });
        },

        updateDeck: function () {
          this.deck = R.map(R.flip(R.nth)(app.adminCards), this.data.deck || []);
        },

        updateMyTurn: function () {
          var that = this;
          game.started.then(function(game){
            that.myTurn = game.turns.isCurrentPlayer(that.userAuth.uid);
          });
        },

        updateMessage: function () {
          this.data.message = game.turns.getStages().getCurrent().description;
        },

        nextTurn: function () {
          game.turns.nextTurn();
        },

        nextStage: function () {
          if (!game.turns.getStages().next()) {
            this.nextTurn();
          }
          this.updateMessage();
        },

        // TODO -- Reset all parts of game
        resetGame: function () {
          this.initData();
          this.joined = false;
        },

        initData: function () {
          this.data = {};
        }
      });
    })(app, R, RSVP);
  </script>
</polymer-element>
