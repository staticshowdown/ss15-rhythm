<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../../bower_components/pvc-globals/pvc-globals.html">

<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../elements/hack-header/hack-header.html">
<link rel="import" href="../../elements/hack-table/hack-table.html">

<polymer-element name="hack-app" attributes="gameId">
  <template>
    <link rel="stylesheet" href="hack-app.css">

    <firebase-element id="base"
      location="{{globals.firebase}}"
      data="{{data}}"
      keys="{{keys}}"
      ref="{{fbRef}}"
      childEvents
      on-child-changed={{childUpdated}}>
    </firebase-element>

    <firebase-element id="root"
      location="{{url}}"
      data="{{rootData}}"
      keys="{{rootKeys}}"
      ref="{{rootRef}}">
    </firebase-element>

    <pvc-globals values="{{globals}}"></pvc-globals>

    <div>
      <hack-header
        started="{{data.started}}"
        turnIndex="{{data.turnIndex}}"
        message="{{data.message}}"
        players="{{data.players}}"
        gameId="{{gameId}}">
      </hack-header>
      <hack-table gameId="{{gameId}}" cards={{cards}}></hack-table>
    </div>

    <div style="position: absolute; bottom: 0; background : #fff; left:0; right: 0;">
     <div horizontal layout>
      <paper-button raised flex
        hidden?="{{!data.started || data.turnIndex !== meIndex }}"
        on-tap="{{nextStage}}">
        <core-icon icon="arrow-forward"></core-icon>
        Next
      </paper-button>
      <paper-button raised flex
        hidden?="{{data.started || !joined}}"
        on-tap="{{startGame}}">
        Start Game
      </paper-button>
      <paper-button raised flex
        hidden?="{{joined}}"
        on-tap="{{joinGame}}">
        Join Game
      </paper-button>
      <paper-button raised flex
        hidden?="{{!data}}"
        on-tap="{{resetGame}}">
        Reset Game
      </paper-button>
     </div>
    </div>

  </template>
  <script>
    (function (app, R, RSVP) {
      'use strict';

      var game, Player;

      Polymer({

        url : 'https://ss15-rhythm.firebaseio.com/',
        gameId : 'defaultGame',
        joined: false,
        observe: { 'data.players': 'updatePlayers' },

        ready: function () {
          this.globals.firebase = this.url + this.gameId;
          game = app.game;
          Player = app.Player;
        },

        startGame: function() {
          game.start();
          this.data.started = true;
          this.cards = game.adminDeck.cards;
          this.turns = game.turns;
          this.updateTurn();
        },

        rootDataChanged : function () {
          this.newGameId(this.gameId);
        },

        newGameId : function (id) {
          var validId = (this.rootKeys.indexOf(id.toString()) !== -1 && id !== "");
          if (!validId) {
            var newId = this.rootRef.push({'bogus':'data'}).key();
            this.gameId = newId;
            window.location.hash = '#/' + newId;
          }
        },

        // TODO -- Make update Player instances instead of
        // replacing with new data.players
        updatePlayers: function () {
          game.players = this.data.players;
        },

        joinGame: function () {
          var that = this;
          if (!that.data) { that.initGameData(); }

          // get current user
          this.authenticate().then(function(userAuth) {

            // add players to game from fb
            var players = R.map(function(player) {
              return new Player(player);
            }, that.data.players || []);

            // add me
            that.meIndex = players.length;
            players.push(new Player({uid: userAuth.uid}));

            // save
            that.data.players = players;
            that.joined = true;
          });
        },

        updateTurn: function () {
          this.turn = this.turns.current;
          this.data.turnIndex = this.turns.index;
          this.updateStage();
        },

        updateStage: function () {
          this.stage = this.turn.getStage();
          this.data.stageIndex = this.turn.index;
          this.data.message = this.stage.description;
        },

        nextTurn: function () {
          game.turns.nextTurn();
          this.updateTurn();
        },

        nextStage: function () {
          if (this.turn.nextStage() ) {
            this.updateStage();
          } else {
            this.nextTurn();
          }
        },

        authenticate: function () {
          var that = this;
          return new RSVP.Promise(function(resolve, reject) {
            that.fbRef.authAnonymously(function(error, userAuth) {
              if (error) {
                reject(error);
                console.log('Login Failed!', error);
              } else {
                resolve(userAuth);
                console.log('Authenticated successfully with payload:', userAuth);
              }
            });
          });
        },

        // TODO -- Make reset cards
        resetGame: function () {
          this.initGameData();
          this.joined = false;
        },

        initGameData: function () {
          this.data = {};
        },

        setPlayers: function (players) {
          // if (!this.data) this.initGameData();
          this.data.players = players || [];
        }
      });
    })(app, R, RSVP);
  </script>
</polymer-element>
